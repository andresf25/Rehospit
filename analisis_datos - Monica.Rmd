---
title: "<center><br>Modelo Predicción de Rehospitalizaciones</br>"
Date: "<center>Marzo de 2018</center>"
output: html_notebook
---

<br><div style="text-align: justify">
El objetivo es desarrollar e implementar un modelo de predicción de rehospitalizaciones para apoyar los programas de evitabilidad post-hospitalaria. El análisis se realizará con información propia del individuo (características sociodemográficas) y datos recolectados por el personal hospitalario, para un periodo de tiempo de dos años y medio que va desde 2016 hasta 2018 </br>

```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE}
rm(list = ls())
library(readxl) #Lectura de archivo excel
library(dplyr) #Procesamiento de datos 
library(ggplot2) # visualizacion graficos
library(ggcorrplot)
library(VIM) # visualizacion y analisis datos perdidos
library(RColorBrewer) #Paletas de colores
library(Information) #Cálculo de WOE y del IV 
library(gridExtra) #Dibujar tablas
library(knitr)
library(kableExtra)
options(scipen=10)
```
<h3>Entendimiento de los Datos</h3>

El archivo contiene registros que corresponden a eventos de rehospitalizaciones y se encuentra detallado a nivel de cada evento hospitalario. En total son 1718 registros, 49 variables, de las cuales se hace un descarte y quedan las siguientes:
```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE}
data_rehosp_s <- read_xlsx("data_rehosp_s.xlsx",na = c("na", "NA", "null", "NULL"))
data_rehosp_s %>%
  select(-Ciudad_Contacto_Nombre_rehosp, 
         -Ciudad_Atencion_Nombre, 
         -Ciudad_Atencion_Nombre_rehosp,
         -Dni_Proveedor, 
         -Dni_Proveedor_rehosp, 
         -Proveedor,
         -Proveedor_rehosp,
         -INDICE, 
         -Categoria_Dx_Id, 
         -Categoria_Dx_Ingreso_Id, 
         -Categoria_Dx_Egreso_Id,
         -Categoria_Dx_Id_rehosp,
         -Categoria_Dx_Ingreso_Id_rehosp,
         -Categoria_Dx_Egreso_Id_rehosp,
         -Codigo_Diagnostico_Op_Ingreso, 
         -Codigo_Diagnostico_Op_egreso, 
         -Codigo_Diagnostico_Op_Ing_rehosp, 
         -Codigo_Diagnostico_Op_Egr_rehosp,
         -Fecha_Ingreso_Hosp, 
         -Fecha_Egreso_Hosp, 
         -Fecha_Ingreso_ReHosp, 
         -Fecha_Egreso_ReHosp, 
         -Estado_Egreso, 
         -Estado_Egreso_rehosp,
         -Rehospitalizacion) %>%
  rename(edad = Edad_Hospitalizacion, 
         estrato = Estrato_Vivienda,
         ingreso = Rango_Ingresos_Desc,
         est_civil = Estado_Civil,
         genero = Genero,
         marcas = cantidad_marcas,
         ramo = Ramo_Id,
         ciudad = Ciudad_Contacto_Nombre,
         diag1 = Codigo_Diagnostico_Op,
         quirur1 = Quirurgico,
         dias_hosp1 = Numero_Dias_Hospitalario,
         dias_uci1 = Numero_Dias_Uci,
         dias_uce1 = Numero_Dias_Uce,
         pago_diag1 = Valor_Pagado_Diagnostico,
         sig_hosp = Dias_Sig_Hosp,
         diag2 = Codigo_Diagnostico_Op_REHOSP,
         quirur2 = Quirurgico_rehosp,
         dias_hosp2 = Numero_Dias_Hospitalario_rehosp,
         dias_uci2 = Numero_Dias_Uci_rehosp,
         dias_uce2 = Numero_Dias_Uce_rehosp,
         pago_diag2 = Valor_Pagado_Diagnostico_rehosp,
         rehosp_oms1 = rehosp_cat_oms,
         rehosp_oms2 = rehosp_subcat_oms) %>%
  mutate(quirur1 = ifelse(quirur1 == 1, 'Si', 'No'),
         quirur2 = ifelse(quirur2 == 1, 'Si', 'No'),
         rehosp_oms1 = ifelse(rehosp_oms1 == 1, 'Si','No'),
         rehosp_dane = ifelse(rehosp_dane == 1, 'Si','No'),
         estrato = ifelse(estrato == -1 | estrato == 0, NA, estrato),
         ingreso = as.factor(ingreso),
         est_civil = as.factor(est_civil),
         ramo = as.factor(ramo),
         genero = as.factor(genero),
         diag1 = as.factor(diag1),
         diag2 = as.factor(diag2),
         ciudad = as.factor(ciudad),
         quirur2 = as.factor(quirur2),
         quirur1 = as.factor(quirur1),
         rehosp_oms1 = as.factor(rehosp_oms1),
         rehosp_dane = as.factor(rehosp_dane),
         estrato = as.factor(estrato)) -> data_rehosp_s
head(data_rehosp_s)
```
Variables numéricas (11):

* <b>edad:</b> Edad del asegurado en el momento de la hospitalizacion
* <b>marcas:</b> Cantidad de marcas confirmadas del asegurado
* <b>dias_hosp1:</b> Dias de hospitalizacion
* <b>dias_uci1:</b> Numero dias en uci
* <b>dias_uce1:</b> Numero dias en uce
* <b>pago_diag1:</b> Valor pagado primera hospitalizacion
* <b>dias_sig_hosp1:</b> Dias hasta la siguiente hospitalizacion
* <b>dias_hosp2:</b> Dias de hospitalizacion
* <b>dias_uci2:</b> Dias en uci
* <b>dias_uce2:</b> Dias en uce
* <b>pago_diag2:</b> Valor pagado


Variables nominales (13):

* <b>estrato:</b> Estrato Vivienda (0,1,2,3,4,5,6,-1)
* <b>ingreso:</b> Rango de ingresos
* <b>estado_civil:</b> Estado civil (C,D,S,U,V,-1)
* <b>genero:</b> Genero del asegurado (M,F)
* <b>ramo:</b> Ramo al que pertenece el asegurado
* <b>ciudad:</b> Ciudad de contacto del asegurado
* <b>diag1:</b> Codigo Diagnostico cie10 de la atencion
* <b>quirurgico1:</b> Si tuvo algun tipo de servicio relacionado a procedimiento quirurgico
* <b>diag2:</b> Codigo Diagnostico cie10 de la rehospitalizacion
* <b>quirurgico2:</b> Si tuvo algun tipo de servicio relacionado a procedimiento quirurgico
* <b>rehosp_dane:</b> Similitud tabla mortalidad dane
* <b>rehosp_cat_oms:</b> Similitud categoria cie10
* <b>rehosp_subcat_oms:</b> Similitud subcategoria cie10 </br>

Generamos estadistica descriptiva de los datos
```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE}
summary(data_rehosp_s)
```

<br><h4>Análisis de Registros Pérdidos</h4>

En la gráfica siguiente podemos observar que hay en total 3 variables que no contienen registros vacios: estrato, estado civil e ingreso. A nivel individual el porcentaje de valores perdidos para todos los casos es superior al 25%. De forma combinada hay 318 registros vacíos en ingreso, 259 en sólo el estrato y 144 en el estado civil, el resto  de los campos nulos corresponde a combinaciones entre dos variables; por ende, no podemos decir que la probabilidad de que falte un valor depende solo del valor observado, y usar un método para imputarlo (la forma no es aleatoria).

```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE, fig.width=10}
aggr(data_rehosp_s, 
     combined = FALSE, 
     numbers = TRUE, 
     prop = c(TRUE, FALSE),
     col = c("#CCE5FF", "#0066CC"),
     cex.axis = 0.7,
     border = NA,
     ylab = c("Proporción de Datos Perdidos", "Combinaciones"))
```

<br>Para corroborar que los datos no faltan al azar, se realiza un grafico de correlación que nos ayude a verificar lo anterior. Para ello, construimos un dataframe que indique si el campo está vacio (1 si lo está, 0 si no) con esta información seleccionamos sólo aquellas columnas que tienen algunos (no todos) sus registros nulos y finalmente creamos la matrix de correlación.</br>

```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE}
matrix_miss <- as.data.frame(abs(is.na(data_rehosp_s)))
only_miss <- matrix_miss[,sapply(matrix_miss, sd) > 0]
corr_miss <- round(cor(only_miss),3)
p.mat <- cor_pmat(only_miss)

ggcorrplot(corr_miss, 
           type = "lower",
           outline.col = "white",
           p.mat = p.mat,
           sig.level = 0.05,
           ggtheme = ggplot2::theme_minimal,
           lab = TRUE,
           colors = c("#99CCFF", "white", "#0066CC")) + 
  labs(title = "Correlacion entre datos perdidos por columna")
```

Los resultados indican que entre los valores faltantes del estrato y el ingreso hay una correlación del 5%, en el caso del estrato y el ingreso civil es del 8% y finalmente la correlación más alta entre valores faltantes, corresponde al ingreso y el estado civil, de un 20%.

Dado que con la anterior matrix, a un nivel de significancia del 5%, se comprobó la hipótesis inicial de no aleatoriedad, se procede a construir una tercera categoría para cada una de las variables que posee campos vacíos.</br>

```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE}
data_rehosp_s %>%
  mutate(estrato = ifelse(is.na(estrato), "Sin Informacion", estrato),
         est_civil = ifelse(is.na(est_civil), "Sin Informacion", est_civil),
         ingreso = ifelse(is.na(ingreso), "Sin Informacion", ingreso),
         estrato = as.factor(estrato),
         est_civil = as.factor(est_civil),
         ingreso = as.factor(ingreso)) -> data_rehosp_s
head(data_rehosp_s)
```

<h3>Análisis Exploratorio</h3>

#Boxplot
```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE}
ggplot(
  data_rehosp_s, 
       aes(x = rehosp_oms1, 
           y=edad, 
           color=rehosp_oms1)) +
  geom_boxplot() + 
  labs(title="Edad por rehosp",
       x="Rehosp", 
       y = "Edad") + 
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5), 
        legend.position = "none") + 
  scale_colour_brewer(palette="Paired")

ggplot(
  data_rehosp_s, 
  aes(x=rehosp_oms1, 
      y=dias_hosp2,
      color=rehosp_oms1)) +
  geom_boxplot() + 
  labs(title="Dias hospit2 por rehosp",
       x="Rehosp", 
       y = "Dias hospit2")  + 
  theme_minimal() + 
  theme(plot.title = element_text(hjust = 0.5),legend.position = "none") + 
  scale_colour_brewer( palette="Paired")

```
#Histogramas
```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE}
data_rehosp_s %>%
  group_by(rehosp_oms1)%>%
  summarise(prom_edad = mean(edad)) -> mean_edad

ggplot(data=data_rehosp_s, 
       aes(data_rehosp_s$edad, 
           color=rehosp_oms1)) + 
  geom_histogram(breaks=seq(18, 100, by = 4), 
                 alpha = .2,
                 fill="white",
                 position = "identity",
                 size=0.8) + 
  geom_vline(data = mean_edad, 
             aes(xintercept=prom_edad, 
                 color=rehosp_oms1),
             linetype="dashed") +
  labs(title="Histograma por Edad", 
       x="Edad", 
       y="Frecuencia") + 
  theme_minimal() + 
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_color_manual(values = c("#99CCFF", "#0066CC"))
```

#Otra manera
```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE}
data_rehosp_s %>% 
  ggplot(., aes(x = estrato)) +
  geom_bar(aes(fill = rehosp_oms1), 
           na.rm = TRUE) +
  theme_minimal() +
  labs(x = "Estrato", 
       y = "Frecuencia", 
       fill = "Rehospitalización") +
  ggtitle("Distribución Estrato") +
  theme(plot.title = element_text(hjust = 0.5)) + scale_fill_brewer(palette = "Paired")
```

Con el objetivo de enriquecer el análisis exploratorio, se calcularán dos medidas muy comúnes de la teoría de la información, éstas permiten inferir algo del poder predictivo que pueden tener las variables independientes, antes de hacer parte de un modelo.

<br><h4>Análisis de clasificación binaria usando WOE y el IV</h4>
El peso de la evidencia (WOE) y el valor de la información (IV) ayudan, entre otras cosas, a determinar la contribución independiente de cada variable al resultado, y detectar relaciones lineales y no lineales. El WOE mide la relación entre la variable predictiva y el objeto binario, mientras que el IV mide la fuerza predictiva de esa relación.


```{r}
data_rehosp_s <- data_rehosp_s %>%
  mutate(id = 1:nrow(.)) 

data_rehosp_s %>%
  sample_frac(size = .70) %>%
  select(-rehosp_dane, 
         -rehosp_oms1, 
         -diag1, 
         -diag2) -> train

data_rehosp_s %>%
  anti_join(x = .,
            y = train, 
            by = "id") %>%
  select(-rehosp_dane, 
         -rehosp_oms1, 
         -diag1, 
         -diag2) -> test

train <- select(.data = train, -id)
test <- select(.data = test, -id)

IV <- create_infotables(data = train,
                   valid = test,
                   y = "rehosp_oms2")


kable_styling(kable(IV$Summary), 
              position = "center", 
              row_label_position = 1,
              full_width = F)
  
```
  
```{r}
kable_styling(kable(IV$Tables$pago_diag1), 
              position = "center", 
              row_label_position = 1,
              full_width = F)
```

```{r}
n <- names(IV$Tables)
for (i in 1:length(n)){
   plot_infotables(IV, n[i])}

MultiPlot(IV, IV$Summary$Variable[1:9])
```

```{r}
MultiPlot(IV, IV$Summary$Variable[10:18])
```

