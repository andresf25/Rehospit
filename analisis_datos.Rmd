---
title: "<center><br>Modelo Predicción de Rehospitalizaciones</br>"
Date: "<center>Marzo de 2018</center>"
output: html_notebook
---

<br><div style="text-align: justify">
El objetivo es desarrollar e implementar un modelo de predicción de rehospitalizaciones para apoyar los programas de evitabilidad post-hospitalaria. El análisis se realizará con información propia del individuo (características sociodemográficas) y datos recolectados por el personal hospitalario, para un periodo de tiempo de dos años y medio que va desde 2016 hasta 2018 </br>

```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE}
rm(list = ls())
list.of.packages <- c("readxl", "dplyr", "ggplot2", "ggcorrplot", "VIM", "RColorBrewer", "Information", "knitr", "kableExtra", "gridExtra", "skimr")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

options(scipen=10)
```
<h3>Entendimiento de los Datos</h3>

El archivo contiene registros que corresponden a eventos de rehospitalizaciones y se encuentra detallado a nivel de cada evento hospitalario. En total son 1718 registros, 49 variables, de las cuales se hace un descarte y quedan las siguientes:
```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE}
data_rehosp_s <- read_xlsx("data_rehosp_s.xlsx",na = c("na", "NA", "null", "NULL"))
data_rehosp_s %>%
  select(-Ciudad_Contacto,
         -Ciudad_Contacto_Nombre_rehosp, 
         -Ciudad_Atencion_Nombre, 
         -Ciudad_Atencion_Nombre_rehosp,
         -Dni_Proveedor, 
         -Dni_Proveedor_rehosp, 
         -Proveedor,
         -Proveedor_rehosp,
         -INDICE, 
         -Categoria_Dx_Id, 
         -Categoria_Dx_Ingreso_Id, 
         -Categoria_Dx_Egreso_Id,
         -Categoria_Dx_Id_rehosp,
         -Categoria_Dx_Ingreso_Id_rehosp,
         -Categoria_Dx_Egreso_Id_rehosp,
         -Codigo_Diagnostico_Op_Ingreso, 
         -Codigo_Diagnostico_Op_egreso, 
         -Codigo_Diagnostico_Op_Ing_rehosp, 
         -Codigo_Diagnostico_Op_Egr_rehosp,
         -Fecha_Ingreso_Hosp, 
         -Fecha_Egreso_Hosp, 
         -Fecha_Ingreso_ReHosp, 
         -Fecha_Egreso_ReHosp, 
         -Estado_Egreso, 
         -Estado_Egreso_rehosp,
         -Rehospitalizacion,
         -rehosp_dane,
         -rehosp_subcat_oms) %>%
  rename(edad = Edad_Hospitalizacion, 
         estrato = Estrato_Vivienda,
         ingreso = Rango_Ingresos_Desc,
         est_civil = Estado_Civil,
         genero = Genero,
         marcas = cantidad_marcas,
         ramo = Ramo_Id,
         ciudad = Ciudad_Contacto_Nombre,
         diag1 = Codigo_Diagnostico_Op,
         quirur1 = Quirurgico,
         dias_hosp1 = Numero_Dias_Hospitalario,
         dias_uci1 = Numero_Dias_Uci,
         dias_uce1 = Numero_Dias_Uce,
         pago_diag1 = Valor_Pagado_Diagnostico,
         sig_hosp = Dias_Sig_Hosp,
         diag2 = Codigo_Diagnostico_Op_REHOSP,
         quirur2 = Quirurgico_rehosp,
         dias_hosp2 = Numero_Dias_Hospitalario_rehosp,
         dias_uci2 = Numero_Dias_Uci_rehosp,
         dias_uce2 = Numero_Dias_Uce_rehosp,
         pago_diag2 = Valor_Pagado_Diagnostico_rehosp,
         rehosp_oms1 = rehosp_cat_oms) %>%
  mutate(quirur1 = ifelse(quirur1 == 1, 'Si', 'No'),
         quirur2 = ifelse(quirur2 == 1, 'Si', 'No'),
         edad = case_when( edad <= 30 ~ "18-30",
                                 edad >= 31 & edad <= 40 ~ "31-40",
                                 edad >= 31 & edad <= 40 ~ "31-40",
                                 edad >= 41 & edad <= 50 ~ "41-50",
                                 edad >= 51 & edad <= 60 ~ "51-60",
                                 edad >= 61 & edad <= 70 ~ "61-70",
                                 edad >= 71 & edad <= 80 ~ "71-80",
                                 edad >= 81 ~ "81+"),
         estrato = ifelse(estrato == -1 | estrato == 0, NA, estrato),
         ramo = as.factor(ramo),
         genero = as.factor(genero),
         diag1 = as.factor(diag1),
         diag2 = as.factor(diag2),
         ciudad = as.factor(ciudad),
         quirur2 = as.factor(quirur2),
         quirur1 = as.factor(quirur1),
         edad = as.factor(edad)) -> data_rehosp_s
head(data_rehosp_s)
```
Variables numéricas (11):

* <b>marcas:</b> Cantidad de marcas confirmadas del asegurado
* <b>dias_hosp1:</b> Dias de hospitalizacion
* <b>dias_uci1:</b> Numero dias en uci
* <b>dias_uce1:</b> Numero dias en uce
* <b>pago_diag1:</b> Valor pagado primera hospitalizacion
* <b>sig_hosp:</b> Dias hasta la siguiente hospitalizacion
* <b>dias_hosp2:</b> Dias de hospitalizacion
* <b>dias_uci2:</b> Dias en uci
* <b>dias_uce2:</b> Dias en uce
* <b>pago_diag2:</b> Valor pagado


Variables nominales (13):

* <b>edad:</b> Edad del asegurado en el momento de la hospitalizacion
* <b>estrato:</b> Estrato Vivienda (0,1,2,3,4,5,6,-1)
* <b>ingreso:</b> Rango de ingresos
* <b>est_civil:</b> Estado civil (C,D,S,U,V,-1)
* <b>genero:</b> Genero del asegurado (M,F)
* <b>ramo:</b> Ramo al que pertenece el asegurado
* <b>ciudad:</b> Ciudad de contacto del asegurado
* <b>diag1:</b> Codigo Diagnostico cie10 de la atencion
* <b>quirur1:</b> Si tuvo algun tipo de servicio relacionado a procedimiento quirurgico
* <b>diag2:</b> Codigo Diagnostico cie10 de la rehospitalizacion
* <b>quirur2:</b> Si tuvo algun tipo de servicio relacionado a procedimiento quirurgico
* <b>rehosp_dane:</b> Similitud tabla mortalidad dane
* <b>rehosp_cat_oms:</b> Similitud categoria cie10
* <b>rehosp_subcat_oms:</b> Similitud subcategoria cie10 </br>

Generamos estadistica descriptiva de los datos
```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE}
skim_with(numeric = list(hist = NULL))

data_rehosp_s %>% 
  group_by() %>%
  skim()
```

<br><h4>Análisis de Registros Pérdidos</h4>

En la gráfica siguiente podemos observar que hay en total 3 variables que no contienen registros vacios: estrato, estado civil e ingreso.

A nivel individual el porcentaje de valores perdidos para todos los casos es superior al 25%. De forma combinada hay 318 registros vacíos en ingreso, 259 en sólo el estrato y 144 en el estado civil, el resto  de los campos nulos corresponde a combinaciones entre dos variables; por ende no podemos decir que la probabilidad de que falte un valor depende solo del valor observado, y usar un método para imputarlo (la forma no es aleatoria).

```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE, fig.width=10, fig.align  = "center"}

aggr(data_rehosp_s, 
     combined = FALSE, 
     numbers = TRUE, 
     prop = c(TRUE, FALSE),
     col = c("#CCE5FF", "#0066CC"),
     cex.axis = 0.7,
     border = NA,
     ylab = c("Proporción de Datos Perdidos", "Combinaciones"))
```

Para corroborar que los datos no faltan al azar, se realiza un grafico de correlación que nos ayude a verificar lo anterior. Para ello, construimos un dataframe que indique si el campo está vacio (1) o no (0); con esta información seleccionamos sólo aquellas columnas que tienen algunos (no todos) sus registros nulos y finalmente creamos la matrix de correlación.

```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE}
matrix_miss <- as.data.frame(abs(is.na(data_rehosp_s)))
only_miss <- matrix_miss[,sapply(matrix_miss, sd) > 0]
corr_miss <- round(cor(only_miss),3)
p.mat <- cor_pmat(only_miss)

ggcorrplot(corr_miss, 
           type = "lower",
           outline.col = "white",
           p.mat = p.mat,
           sig.level = 0.05,
           ggtheme = ggplot2::theme_minimal,
           lab = TRUE,
           colors = c("#99CCFF", "white", "#0066CC")) + 
  labs(title = "Correlacion entre datos perdidos por columna")
```

Dado que con la anterior matrix a un nivel de significancia del 5% se comprueba la hipótesis inicial de no aleatoriedad, se procede a construir una tercera categoría para cada una de las variables que posee campos vacíos.

```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE}
data_rehosp_s %>%
  mutate(estrato = ifelse(is.na(estrato), "Sin Informacion", estrato),
         est_civil = ifelse(is.na(est_civil), "Sin Informacion", est_civil),
         ingreso = ifelse(is.na(ingreso), "Sin Informacion", ingreso),
         estrato = as.factor(estrato),
         est_civil = as.factor(est_civil),
         ingreso = as.factor(ingreso)) -> data_rehosp_s2
head(data_rehosp_s2)
```

<h3>Análisis Exploratorio</h3>

<br><h4>Análisis univariado - variables continuas</h4>

Se puede observar que tanto en el numéro de marcas como en la variable de pago, correspondiente al primer diagnóstico, no parece haber una diferencia significativa en la distribución al discriminar por la variable objetivo binaria, es decir, entre los casos de rehospitalización (1) y casos de no rehospitalización (0). Adicionalmente, la distibución en ambas variables no es simétrica. En el caso de las marcas se observa una asimetría positiva o sesgada a la derecha y de manera similar, aunque menos marcada, para el caso del pago en el primer diagnóstico.

Los datos se encuentran bastante dispersos y reflejan presencia de outliers.

```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE}

myboxplot <- function(mydata, myexposure, myoutcome, mytitle, mylabel_x, mylabel_y, my_fill){
  bp <- ggplot(
    mydata, 
    aes(x = as.factor(myexposure), 
        y = myoutcome,
        color=as.factor(myexposure))) +
    geom_boxplot() + 
    labs(title = mytitle,
       x= mylabel_x, 
       y = mylabel_y,
       fill = my_fill) +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5), 
        legend.position = "none") + 
  scale_colour_brewer(palette="Paired")
  return(bp)
}

p1 <- myboxplot(data_rehosp_s, data_rehosp_s$rehosp_oms1, data_rehosp_s$marcas, "", "Rehospitalización", "Marcas", "Rehospitalización")

p2 <- myboxplot(data_rehosp_s, data_rehosp_s$rehosp_oms1, data_rehosp_s$pago_diag1, "", "Rehospitalización", "Pago Diag1", "")


ggplot(
  data_rehosp_s, 
  aes(x = marcas, 
      color =  as.factor(rehosp_oms1), 
      shape = as.factor(rehosp_oms1))) + 
  geom_density() +
  labs(title="Total de marcas",
       x = "", 
       y = "Frecuencia") +
  theme_light() + 
  theme(plot.title = element_text(hjust = 0.5),legend.position = "none") +
  scale_colour_manual(values = c("#99CCFF", "#0066CC")) -> p3

ggplot(
  data_rehosp_s, 
  aes(x = pago_diag1, 
      color =  as.factor(rehosp_oms1), 
      shape = as.factor(rehosp_oms1))) + 
  geom_histogram(alpha = .2,
                 fill= "white", 
                 position = "identity",
                 size = 0.8) + 
  labs(title = "Pago primer diágnóstico",
       x = "", 
       y = "Frecuencia") +
  theme_light() + 
  theme(plot.title = element_text(hjust = 0.5),legend.position = "none") +
  scale_colour_manual(values = c("#99CCFF", "#0066CC")) -> p4


grid.arrange(p3, p4, p1, p2, nrow = 2, ncol = 2)
```


Es evidente la existencia también, de valores atípicos muy marcados tanto en el numéro de días de hospitalización, como en los números de días que el paciente estuvo en la Unidad de Cuidado Intensivo y Especial, en dónde los valores atípicos más grandes suceden en los eventos que terminaron en rehospitalización.

Cabe anotar, que puede existir una colinealidad entre la vaiable días UCE y UCI que debe ser validada más adelante, ya que los pacientes que pasaron por un momento de crisis en la UCI, suelen ser luego remitidos a la UCE cuando sus signos vitales se encuentran más estables y están en proceso de mejora.

Finalmente, analizando la variable que nos indica el número de días siguientes hasta la siguiente hospitalización, hay una diferencia muy leve entre grupos, con un valor en la mediana inferior pára los casos de rehospitalización.

```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE}

p5 <- myboxplot(data_rehosp_s, data_rehosp_s$rehosp_oms1, data_rehosp_s$dias_hosp1, "Total dias hospitalizado", "", "Dias hospitalización", "")

p6 <- myboxplot(data_rehosp_s, data_rehosp_s$rehosp_oms1, data_rehosp_s$sig_hosp, "Total dias siguientes", "", "Dias sig hosp", "")

p7 <- myboxplot(data_rehosp_s, data_rehosp_s$rehosp_oms1, data_rehosp_s$dias_uci1, "Total días UCI", "", "Dias UCI", "")

p8 <- myboxplot(data_rehosp_s, data_rehosp_s$rehosp_oms1, data_rehosp_s$dias_uce1, "Total días UCE", "", "Dias UCE", "")

grid.arrange(p5, p6, p7, p8, 
             ncol = 2, 
             nrow = 2)
```

#Gráfico Barras
=======
<br><h4>Análisis univariado - variables cardinales</h4>

Observando las variables categóricas la diferencia entre la probabilidad de que el evento ocurra (haya rehospitalización) o no, se puede evidenciar sólo en algunas clases por categoría, pero en general, las proporciones suelen ser bastantes similares, por lo que no es posible elaborar a priori una hipótesis que estipule diferencias significativas en las distribuciones, por lo menos para ninguna de las tres variables relacionadas en el gráfico a continuación.


```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE}

mygeom_bar <- function(mydata, myexposure, myoutcome, mytitle, mylabel_x, mylabel_y, my_fill, my_angle){
  bp <- 
  ggplot(
    mydata, 
    aes(x = myexposure)) +
  geom_bar(
    aes(fill = as.factor(myoutcome)),
    na.rm = TRUE) +
  theme_minimal() +
  labs(x = mylabel_x, 
       y = mylabel_y, 
       fill = my_fill) +
  ggtitle(mytitle) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "none") + 
  scale_fill_brewer(palette = "Paired") + 
    
  { # angle
  if (!is.null(my_angle)) theme(axis.text.x = element_text(angle = my_angle), 
      legend.position = "none")  } +
  
  { # angle
  if (!is.null(my_angle)) coord_flip() } 
  
  return(bp)
}


p9 <- mygeom_bar(data_rehosp_s, data_rehosp_s$edad, data_rehosp_s$rehosp_oms1, "Edad", "", "Frecuencia", "Rehospitalización", NULL)

p10 <- mygeom_bar(data_rehosp_s, data_rehosp_s$estrato, data_rehosp_s$rehosp_oms1, "Estrato", "", "Frecuencia", "Rehospitalización", NULL)

p11 <- mygeom_bar(data_rehosp_s, data_rehosp_s$genero, data_rehosp_s$rehosp_oms1, "Género", "", "Frecuencia", "Rehospitalización", NULL)

grid.arrange(p9,                                    
             p10, p11,                               
             ncol = 2, nrow = 2,
             layout_matrix = rbind(c(1,1), c(2,3)))
```


Por otro lado, los atributos que indican: el rango de ingreso, el hecho de que se hayan realizado procedimientos quirúrgicos durante la primera hospitalización y de igual forma el hecho de se hayan realizado cirugías durante la segunda hospitalización muestran cierta diferencia en la distribuión por grupo. Por ejemplo, cuando se realizan cirugías derivadas del primer diagnóstico, es más probable que la persona deba ser rehospitalizada de nuevo.

```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE}

p12 <- mygeom_bar(data_rehosp_s, data_rehosp_s$ingreso, data_rehosp_s$rehosp_oms1, "Ingreso", "", "Frecuencia","Rehospitalización", 90)

p13 <- mygeom_bar(data_rehosp_s, data_rehosp_s$quirur2, data_rehosp_s$rehosp_oms1, "Proc quirúrgico rehosp", "", "Frecuencia", "Rehospitalización", NULL)

p14 <- mygeom_bar(data_rehosp_s, data_rehosp_s$quirur1, data_rehosp_s$rehosp_oms1, "Proc quirúrgico", "", "Frecuencia", "Rehospitalización", NULL)

grid.arrange(p12,
            p13, p14,
            ncol = 2,
            nrow = 2,
            layout_matrix = cbind(c(1,1), c(2,3)))
```

```{r, warning = FALSE, message = FALSE, echo = FALSE, eval = FALSE}

p15 <- mygeom_bar(data_rehosp_s, data_rehosp_s$ramo, data_rehosp_s$rehosp_oms1, "Ramo Seguro", "", "Frecuencia", "Rehospitalización")

p16 <- mygeom_bar(data_rehosp_s, data_rehosp_s$est_civil, data_rehosp_s$rehosp_oms1, "Estado civil", "", "Frecuencia", "Rehospitalización")

grid.arrange(p15, p16)
```

Con el objetivo de enriquecer el análisis exploratorio, se calcularán dos medidas muy comúnes de la teoría de la información, éstas permiten inferir algo del poder predictivo que pueden tener las variables independientes, antes de hacer parte de un modelo.

<br><h4>Análisis de clasificación binaria usando WOE y el IV</h4>
El peso de la evidencia (WOE) y el valor de la información (IV) ayudan, entre otras cosas, a determinar la contribución independiente de cada variable al resultado, y detectar relaciones lineales y no lineales. El WOE mide la relación entre la variable predictiva y el objeto binario, mientras que el IV mide la fuerza predictiva de esa relación.

La tabla a continuación contiene los valores del "valor de la información" con y sin el ajuste derivado de la validación cruzada. Cuando se realiza el ajuste con el objetivo de que los resultados sean más estables, sólo el pago del diagnóstico, si el paciente pasó por la Unidad de cuidados Especiales la primera vez y si fueron realizados procedimientos quirúrgicos serán las únicas variables con suficiente capacidad de predicción a nivel individual y univariable (Iv > 5%). Cuando se relaja el supuesto, IV sin restar el penalty, se incluirían las marcas y la edad y la ciudad.

```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE}
set.seed(1234)

data_rehosp_s <- data_rehosp_s %>%
  mutate(id = 1:nrow(.)) 

data_rehosp_s %>%
  sample_frac(size = .70) %>%
  select(-diag1, 
         -diag2) -> train

data_rehosp_s %>%
  anti_join(x = .,
            y = train, 
            by = "id") %>%
  select(-diag1, 
         -diag2) -> test

train <- select(.data = train, -id)
test <- select(.data = test, -id)

IV <- create_infotables(data = train,
                   valid = test,
                   y = "rehosp_oms1")


kable_styling(kable(IV$Summary), 
              position = "center", 
              row_label_position = 1,
              full_width = F)
```

Enfocandonos en el pago del diagnóstico, el cual, es la variable con mayor influencia, el WOE nos indica una relación no lineal. con un incremento en el WOE a medida que disminuye el rango de pago en el diagnóstico. 

```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE}
kable_styling(kable(IV$Tables$pago_diag1), 
              position = "center", 
              row_label_position = 1,
              full_width = F)
```

```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE}
n <- names(IV$Tables)
for (i in 1:length(n)){
   plot_infotables(IV, n[i])}

MultiPlot(IV, IV$Summary$Variable[1:9])
```

```{r, message = FALSE, warning = FALSE, echo = FALSE, eval =TRUE}
MultiPlot(IV, IV$Summary$Variable[10:18])
```

